#!/usr/bin/env bash
set -eo pipefail

# For instances where a glob has no matches we want an empty list
shopt -s nullglob

# Save all of STDIN in the default $REPLY variable
# (discarding the non-zero exit code for reaching the end-of-file)
read -rd '' ||:

hookname=$1
shift

# Run a hook script, if it's executable, with the input from this invocation
feedhook () {
  if [[ -f "$1" && -x "$1" ]]; then
    echo -n "$REPLY" | "$@"
  fi
}

# Run all numbered scripts under directories with this hook's name
run_numbered_hook () {
  # Gather every file into an array, prefixing each item with the
  # filename of the script (its position in sort order)
  local filelist=()
  for hook in $PLUSHU_ROOT/plugins/*/hooks/$1/*; do
    filelist+=("${hook##*/} $hook")
  done

  # Use newline as separator for easy sortability
  local IFS=$'\n'

  # Sort the array numerically
  filelist=(`printf '%s\n' "${filelist[@]}" | sort -n`)

  # Call each script in sorted order
  for hookline in "${filelist[@]}"; do
    feedhook ${hookline#* }
  done
}

# Ensure we have a hook name
if [[ -z "$hookname" ]]; then
  echo "runhook: missing hook name" >&2
  exit 1
fi

# Ensure we have a root directory
if [[ -z "$PLUSHU_ROOT" ]]; then
  echo "runhook: PLUSHU_ROOT not defined" >&2
  exit 1
fi

# Run ordered pre-hooks
run_numbered_hook pre-$1

# Run other pre-hooks
for hook in $PLUSHU_ROOT/plugins/*/hooks/pre-$hookname; do
  feedhook $hook "$@"
done

# Run normal hooks
for hook in $PLUSHU_ROOT/plugins/*/hooks/$hookname; do
  feedhook $hook "$@"
done

# Run ordered (post)hooks
run_numbered_hook $1
