#!/usr/bin/env bash
set -eo pipefail

export PLUSHU_ROOT=${PLUSHU_ROOT:-~plushu}

# Source configuration variables if the config file is present
[[ -f $PLUSHU_ROOT/plushurc ]] && source $PLUSHU_ROOT/plushurc

# Echo all commands if PLUSHU_TRACE is set
[[ $PLUSHU_TRACE ]] && set -x

# Handle reentrant command-as-string arguments, as used by SSH
if [[ $1 == "-c" ]]; then
  xargs $0 <<<"$2"
  exit
fi

# For instances where a glob has no matches we want an empty list
shopt -s nullglob

# Run "commands" hooks for any plugins to handle
for script in $PLUSHU_ROOT/plugins/*/commands; do
  $script "$@"
done

# Run command/subcommand scripts
if [[ -x "$PLUSHU_ROOT/plugins/$1/command" ]]; then
  PLUSHU_PLUGIN_NAME=$1 "$PLUSHU_ROOT/plugins/$1/command" "$@"
elif [[ -x "$PLUSHU_ROOT/plugins/${1%%:*}/subcommands/${1#*:}" ]]; then
  PLUSHU_PLUGIN_NAME=${1%%:*} "$PLUSHU_ROOT/plugins/${1%%:*}/subcommands/${1#*:}" "$@"
fi
